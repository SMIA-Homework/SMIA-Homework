<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SMIA Homework Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    .role-indicator { position: relative; padding-right: 30px; }
    .role-indicator::after { content: ''; position: absolute; top: 50%; right: 10px; transform: translateY(-50%); width: 12px; height: 12px; border-radius: 50%; }
    .teacher::after { background-color: #3B82F6; }
    .guardian::after { background-color: #10B981; }
    .grid-stack { display: grid; grid-template-rows: auto 1fr; height: 100vh; }
  </style>
</head>
<body class="bg-gray-50">
  <div class="grid-stack">
    <header class="bg-white shadow-sm">
      <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
        <div class="flex items-center">
          <img src="SMIA.jpg" alt="School logo" class="h-20 w-22 rounded-full">
          <h1 class="ml-3 text-xl font-semibold text-gray-900">SMIA Homework Tracker</h1>
        </div>
        <div class="flex items-center space-x-4">
          <div id="currentUserDisplay" class="hidden md:flex items-center">
            <span id="usernameDisplay" class="font-medium"></span>
            <span id="roleDisplay" class="role-indicator ml-2 px-3 py-1 rounded-full text-sm font-medium"></span>
          </div>
          <div id="authSection" class="flex space-x-2">
            <button id="showLogin" class="px-3 py-1 rounded-md bg-blue-600 text-white hover:bg-blue-700 text-sm">Login</button>
            <button id="logoutBtn" class="hidden px-3 py-1 rounded-md bg-gray-200 hover:bg-gray-300 text-sm">Logout</button>
          </div>
        </div>
      </div>
    </header>
    <main class="max-w-7xl mx-auto px-4 py-6">
      <div id="loginForm" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Login to Homework Tracker</h2>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">I am a</label>
          <select id="userRole" class="w-full px-3 py-2 border border-gray-300 rounded-md"><option value="teacher">Teacher</option><option value="guardian">Guardian</option></select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">Class</label>
          <select id="userClass" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <option value="Play">Play</option><option value="Nursery">Nursery</option><option value="1">Class 1</option><option value="2">Class 2</option><option value="3">Class 3</option><option value="4">Class 4</option><option value="5">Class 5</option><option value="6">Class 6</option><option value="7">Class 7</option><option value="8">Class 8</option>
          </select>
        </div>
        <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Username</label><input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 rounded-md"/></div>
        <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-1">Password</label><input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 rounded-md"/></div>
        <div class="flex items-center justify-between"><button id="loginBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Login</button></div>
      </div>

      <div id="dashboard" class="hidden">
        <div class="flex justify-between items-center mb-6">
          <h2 id="dashboardTitle" class="text-2xl font-bold text-gray-800"></h2>
          <div class="space-x-2">
            <button id="addHomeworkBtn" class="px-3 py-1 bg-blue-600 text-white rounded-md text-sm hidden">Add Homework</button>
            <button id="exportPdfBtn" class="px-3 py-1 bg-green-600 text-white rounded-md text-sm">Export PDF</button>
          </div>
        </div>

        <div class="bg-white shadow-sm rounded-lg overflow-hidden mb-4">
          <div class="overflow-x-auto" id="tableContainer">
            <table class="homework-table min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>
              <th>Date</th><th>Class</th><th>Subject</th><th>Homework</th><th>Teacher</th><th id="actionsHeader">Actions</th>
            </tr></thead>
            <tbody id="homeworkTableBody"></tbody>
            </table>
          </div>
        </div>
        <div id="emptyState" class="hidden mt-12 text-center"><img src="https://storage.googleapis.com/…empty.png" class="mx-auto h-48"/><h3 class="mt-4 text-lg font-medium">No homework assigned yet</h3><p class="mt-1 text-sm text-gray-500">Add homework or export</p></div>
      </div>

      <div id="addHomeworkModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
          <div class="flex justify-between mb-4"><h3 class="text-lg font-semibold">Add Homework</h3><button id="closeModal" class="text-gray-500">&times;</button></div>
          <form id="homeworkForm">
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Subject</label><input type="text" id="hwSubject" required class="w-full px-3 py-2 border border-gray-300 rounded-md" /></div>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Homework</label><textarea id="hwText" required class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea></div>
            <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-1">Teacher's Name</label><input type="text" id="hwTeacher" required class="w-full px-3 py-2 border border-gray-300 rounded-md" /></div>
            <div class="flex justify-end"><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Save</button></div>
          </form>
        </div>
      </div>
    </main>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const { jsPDF } = window.jspdf;

    const firebaseConfig = { apiKey:"…", /* your config */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentUser = null, homeworkData = [];

    // DOM listeners
    document.getElementById("loginBtn").addEventListener("click", handleLogin);
    document.getElementById("logoutBtn").addEventListener("click", handleLogout);
    document.getElementById("addHomeworkBtn").addEventListener("click", () => showModal(true));
    document.getElementById("closeModal").addEventListener("click", () => showModal(false));
    document.getElementById("homeworkForm").addEventListener("submit", handleHomeworkSubmit);
    document.getElementById("exportPdfBtn").addEventListener("click", exportToPDF);

    // Restore login
    window.addEventListener("DOMContentLoaded", () => {
      const u = localStorage.getItem("currentUser");
      if (u) { currentUser = JSON.parse(u); updateUI(); }
    });

    function handleLogin() {
      const r = document.getElementById("userRole").value;
      const c = document.getElementById("userClass").value;
      const u = document.getElementById("username").value.trim();
      const p = document.getElementById("password").value.trim();
      if ((r==="teacher" && (u!=="SMIAT"||p!=="teachers")) || (r==="guardian" && (u!=="SMIAG"||p!=="guardians"))) {
        return alert("Invalid credentials");
      }
      currentUser = { username:u, role:r, class:c };
      localStorage.setItem("currentUser", JSON.stringify(currentUser));
      updateUI();
    }

    function handleLogout() {
      currentUser = null;
      localStorage.removeItem("currentUser");
      document.getElementById("loginForm").classList.remove("hidden");
      document.getElementById("dashboard").classList.add("hidden");
      document.getElementById("logoutBtn").classList.add("hidden");
    }

    function updateUI() {
      document.getElementById("loginForm").classList.add("hidden");
      document.getElementById("dashboard").classList.remove("hidden");
      document.getElementById("logoutBtn").classList.remove("hidden");
      document.getElementById("usernameDisplay").textContent = currentUser.username;
      const rd = document.getElementById("roleDisplay");
      rd.textContent = currentUser.role; rd.className = `role-indicator ${currentUser.role}`;
      document.getElementById("dashboardTitle").textContent = `${currentUser.role==="teacher" ? "Teacher Dashboard" : "Homework View"} - Class ${currentUser.class}`;
      document.getElementById("addHomeworkBtn").classList.toggle("hidden", currentUser.role!=="teacher");
      document.getElementById("actionsHeader").style.display = currentUser.role==="teacher" ? "" : "none";
      db.ref(`homework/class${currentUser.class}`).on("value", snap => {
        const d = snap.val();
        homeworkData = d ? Object.entries(d).map(([id, v]) => ({id, ...v})) : [];
        renderHomework();
      });
    }

    function handleHomeworkSubmit(e) {
      e.preventDefault();
      const sub = document.getElementById("hwSubject").value.trim();
      const txt = document.getElementById("hwText").value.trim();
      const tchr = document.getElementById("hwTeacher").value.trim();
      const hw = { date: new Date().toISOString().split('T')[0], subject:sub, text:txt, teacher:tchr, class:currentUser.class };
      db.ref(`homework/class${currentUser.class}`).push(hw);
      showModal(false);
      e.target.reset();
    }

    function deleteHomework(id) {
      db.ref(`homework/class${currentUser.class}/${id}`).remove();
    }

    function renderHomework() {
      const tb = document.getElementById("homeworkTableBody");
      tb.innerHTML = "";
      const filtered = homeworkData.filter(hw => hw.class===currentUser.class);
      if (filtered.length === 0) return document.getElementById("emptyState").classList.remove("hidden");
      document.getElementById("emptyState").classList.add("hidden");
      filtered.forEach(hw => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="px-6 py-4">${hw.date}</td><td class="px-6 py-4">${hw.class}</td><td class="px-6 py-4">${hw.subject}</td><td class="px-6 py-4">${hw.text}</td><td class="px-6 py-4">${hw.teacher}</td><td class="px-6 py-4">${currentUser.role==="teacher" ? `<button class="text-red-600" onclick="deleteHomework('${hw.id}')">Delete</button>` : ""}</td>`;
        tb.appendChild(tr);
      });
    }

    function showModal(open) {
      document.getElementById("addHomeworkModal").classList.toggle("hidden", !open);
    }

    async function exportToPDF() {
      const container = document.getElementById("tableContainer");
      const canvas = await html2canvas(container, { scale:2 });
      const img = canvas.toDataURL("image/png");
      const pdf = new jsPDF({ unit:"pt", format:"a4" });
      const pageWidth = pdf.internal.pageSize.getWidth();
      const imgProps = pdf.getImageProperties(img);
      const imgHeight = (imgProps.height * pageWidth) / imgProps.width;

      pdf.setFontSize(18);
      pdf.text("SMIA Homework Tracker", pageWidth / 2, 40, { align:"center" });
      const logo = document.querySelector("header img");
      if (logo) {
        const logoCanvas = await html2canvas(logo, { scale:2 });
        const logoImg = logoCanvas.toDataURL("image/png");
        const logoHeight = 50;
        pdf.addImage(logoImg, "PNG", (pageWidth - 50) / 2, 60, 50, logoHeight);
      }

      pdf.addImage(img, "PNG", 20, 120, pageWidth - 40, imgHeight);
      pdf.save(`SMIA_Homework_${currentUser.class}_${new Date().toISOString().split("T")[0]}.pdf`);
    }
  </script>
</body>
</html>
